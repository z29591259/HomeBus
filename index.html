<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="manifest" href="manifest.json">
		<title>八德惠爾得公車資訊</title>
		<script>
		const url = 'https://script.google.com/macros/s/AKfycbxVH6wsfiRs_u-GSLVKVoENVX_SfJ7wUSFEqTB_hDFleA4NzEY/exec?key=7dKw1ubRxz4EtL2EuN5ZWKZPT9GBeL6T';
		window.addEventListener('load', function(){
			fetch(url,{
  			  method:'GET',
			  headers: {
			    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
			  }
			})
			.then(res => {
			    return res.json();
			}).then(result => {
			    let estimate = [];
				for(let i=0;i<result.length;i++){
					let text = '';
					if(result[i]['PlateNumb'] == '-1' || result[i]['PlateNumb'] == ''){
						text = getStatus(result[i]['StopStatus'], result[i]['NextBusTime']);
					}else{
						if(result[i]['EstimateTime'] > 60){
							text = Math.ceil(result[i]['EstimateTime']/60)+'分後到'+result[i]['StopName']['Zh_tw'];
						}else{
							text = '1分鐘內到'+result[i]['StopName']['Zh_tw'];
						}
					}
					estimate.push({
						name: result[i]['SubRouteName']['Zh_tw'],
						no: result[i]['PlateNumb'],
						text: text
					});
				}
				showResult(estimate);
			})
			.catch(function(err) {
			    alert(err);
			});
			
			document.getElementById('refresh').addEventListener('click', function(){
				window.location.reload();
			});
			
			if ('serviceWorker' in navigator) {
			  //console.log("Will the service worker register?");
			  navigator.serviceWorker.register('service-worker.js')
			    .then(function(reg){
			      //console.log("Yes, it did.");
			    }).catch(function(err) {
			      //console.log("No it didn't. This happened: ", err)
			    });
			}
						
			let btnAddHomescreen = document.getElementById('add_homescreen');
			btnAddHomescreen.addEventListener('click', (e) => {
			  // hide our user interface that shows our A2HS button
			  btnAddHomescreen.style.display = 'none';
			  // Show the prompt
			  deferredPrompt.prompt();
			  // Wait for the user to respond to the prompt
			  deferredPrompt.userChoice
			    .then((choiceResult) => {
			      if (choiceResult.outcome === 'accepted') {
			        console.log('User accepted the A2HS prompt');
			      } else {
			        console.log('User dismissed the A2HS prompt');
			      }
			      deferredPrompt = null;
			    });
			});
		});
		
		let deferredPrompt;
		window.addEventListener('beforeinstallprompt', (e) => {
		  e.preventDefault();
		  deferredPrompt = e;
		  // Update UI notify the user they can add to home screen
		  btnAddHomescreen.style.display = 'block';
		});
		
		function showResult(estimate){
			let content = '';
			for(let i=0;i<estimate.length;i++){
				content += '<div class="info_row">'+
					'<div class="info_name">'+estimate[i]['name'] + '</div>'+
					'<div class="info_no">'+estimate[i]['no']+'</div>'+
					'<div class="info_text">' + estimate[i]['text']+'</div>'+
				'</div>';
			}
			document.getElementById('estimate_info').innerHTML = content;
		}		
		function getStatus(status, next_time){
			if(status === 1){
				var time = new Date(next_time);
				var hour = time.getHours() < 10 ? '0'+time.getHours() : time.getHours();
				var minute = time.getMinutes() < 10 ? '0'+time.getMinutes() : time.getMinutes();
				return hour + ':' + minute + '發車';
			}else if(status === 2){
				return '交管不停靠';
			}else if(status === 3){
				return '末班車已過';
			}else if(status === 4){
				return '今日未營運';
			}
		}
		</script>
		<style>
		html{
			height: 100%;
			background: -webkit-linear-gradient(#A9B0EE,#49A9EB);
		}
		body{
			padding: 0;
		}
		body *{
			text-align: center;
		}
		#add_homescreen{
			display: none;
		}
		.info_row{
			padding: .5em 0;
		}
		.info_name{
			display: inline-block;
			width: 25%;
		}
		.info_no{
			display: inline-block;
			width: 30%;
		}
		.info_text{
			display: inline-block;
			width: 45%;
		}
		footer{
			position: absolute;
			left: 50%;
    		transform: translateX(-50%);
			bottom: 1em;
			padding: 0;
			margin-left: .5em;
			margin-right: .5em;
			text-align: left;
		}
		</style>
	</head>
	<body>
		<center>
			<h1>八德惠爾得公車資訊</h1>
		</center>
		<div id="estimate_info">讀取中...</div>
		<div>
			<input id="refresh" type="button" value="重新整理" />&nbsp;
			<input id="add_homescreen" type="button" value="新增到桌面"/>
		</div>
		<footer>
			資料來源:&nbsp;<a href="https://ptx.transportdata.tw/PTX">交通部PTX平台</a>
			Email:&nbsp;<a href="mailto:admin@woodloch.blog">admin@woodloch.blog</a><br />
			Blog:&nbsp;<a href="https://woodloch.blog">木澤的研發腦</a>&nbsp;&nbsp;<a href="https://github.com/z29591259/HomeBus">GitHub</a>
		</footer>
	</body>
</html>